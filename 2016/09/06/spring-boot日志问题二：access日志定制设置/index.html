<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> spring-boot日志问题二：access日志定制设置 · coffeesweet</title><meta name="description" content="spring-boot日志问题二：access日志定制设置 - coffeesweet"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.coffeesweet.me/atom.xml" title="coffeesweet"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/2560434425" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/coffeesweet" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">spring-boot日志问题二：access日志定制设置</h1><div class="post-info">Sep 6, 2016</div><div class="post-content"><p>spring默认的accesslog相关的配置项比较少，类似自定义日志名称的日期格式修改成小时等设置没有对外开放设置入口，需要自己扩展<br><a id="more"></a></p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>spring默认的accesslog相关的配置项比较少，只有如下几项：</p>
<p><strong>applicatio.propertie</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server.tomcat.accesslog.directory=logs # Directory in which log files are created. Can be relative to the tomcat base dir or absolute.</div><div class="line">server.tomcat.accesslog.enabled=false # Enable access log.</div><div class="line">server.tomcat.accesslog.pattern=common # Format pattern for access logs.</div><div class="line">server.tomcat.accesslog.prefix=access_log # Log file name prefix.</div><div class="line">server.tomcat.accesslog.suffix=.log # Log file name suffix.</div></pre></td></tr></table></figure></p>
<ol>
<li>默认的fileDateFormat（日志文件输出规则，是按照天，还是小时等方式输出日志个数）是按照天的，格式：.yyyy-MM-dd 而且这个还不能在启动的时候或配置文件进行设置。</li>
<li>还有accessLogBufferedEnabled这个指定access日志是否缓冲输出的开关也无法在配置文件配置。</li>
</ol>
<h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>在App.java中添加了定制程序：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * tomcat access 日志开关</div><div class="line"> */</div><div class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;server.tomcat.accesslog.enabled:false&#125;"</span>)</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> accessLogEnabled;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *tomcat access 日志内容格式</div><div class="line"> */</div><div class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;server.tomcat.accesslog.pattern:common&#125;"</span>)</div><div class="line"><span class="keyword">private</span> String accessLogPattern;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * tomcat access 日志所在目录</div><div class="line"> */</div><div class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;server.tomcat.accesslog.directory:logs&#125;"</span>)</div><div class="line"><span class="keyword">private</span> String accessLogDirectory;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * tomcat access 日志名称前缀</div><div class="line"> */</div><div class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;server.tomcat.accesslog.prefix:access_log&#125;"</span>)</div><div class="line"><span class="keyword">private</span> String accessLogPrefix;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * tomcat access 日志名称后缀</div><div class="line"> */</div><div class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;server.tomcat.accesslog.suffix:.log&#125;"</span>)</div><div class="line"><span class="keyword">private</span> String accessLogSuffix;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Flag to determine if log rotation should occur. If set to false, then this file is</div><div class="line"> * never rotated and fileDateFormat is ignored. Default value: true</div><div class="line"> * <span class="doctag">@link</span> https://tomcat.apache.org/tomcat-7.0-doc/config/valve.html#Access_Log_Valve</div><div class="line"> * <span class="doctag">@link</span> http://stackoverflow.com/questions/23596157/spring-boot-tomcat-access-logs/35001421#35001421</div><div class="line"> */</div><div class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;server.tomcat.accesslog.rotatable:true&#125;"</span>)</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> accessLogRotatable;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Allows a customized timestamp in the access log file name. The file is rotated whenever</div><div class="line"> * the formatted timestamp changes. The default value is yyyy-MM-dd. If you wish to rotate</div><div class="line"> * every hour, then set this value to yyyy-MM-dd.HH. The date format will always be</div><div class="line"> * localized using the locale en_US.</div><div class="line"> * <span class="doctag">@link</span> https://tomcat.apache.org/tomcat-7.0-doc/config/valve.html#Access_Log_Valve</div><div class="line"> * <span class="doctag">@link</span> http://stackoverflow.com/questions/23596157/spring-boot-tomcat-access-logs/35001421#35001421</div><div class="line"> */</div><div class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;server.tomcat.accesslog.fileDateFormat:.yyyy-MM-dd.HH&#125;"</span>)</div><div class="line"><span class="keyword">private</span> String accessLogFileDateFormat;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * accessLog buffered output switch</div><div class="line"> */</div><div class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;server.tomcat.accesslog.accessLogBufferedEnabled:true&#125;"</span>)</div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> accessLogBufferedEnabled;</div><div class="line"></div><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="function"><span class="keyword">public</span> TomcatEmbeddedServletContainerFactory <span class="title">tomcatEmbeddedServletContainerFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">TomcatEmbeddedServletContainerFactory tomcatFactory = <span class="keyword">new</span> TomcatEmbeddedServletContainerFactory();</div><div class="line"></div><div class="line">tomcatFactory.addContextCustomizers(<span class="keyword">new</span> TomcatContextCustomizer() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (Valve valve : context.getPipeline().getValves()) &#123;</div><div class="line">            <span class="keyword">if</span> (valve <span class="keyword">instanceof</span> org.apache.catalina.valves.AccessLogValve) &#123;</div><div class="line">                AccessLogValve accessLogValve = (AccessLogValve) valve;</div><div class="line">                accessLogValve.setPattern(accessLogPattern);</div><div class="line">                accessLogValve.setDirectory(accessLogDirectory);</div><div class="line">                accessLogValve.setPrefix(accessLogPrefix);</div><div class="line">                accessLogValve.setSuffix(accessLogSuffix);</div><div class="line">                accessLogValve.setRotatable(accessLogRotatable);</div><div class="line">                accessLogValve.setFileDateFormat(accessLogFileDateFormat);</div><div class="line"></div><div class="line">                <span class="comment">/* 关闭access的buffer输出 */</span></div><div class="line">                accessLogValve.setBuffered(accessLogBufferedEnabled);</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * 修改valve的属性后不需要添加到context了,再添加就变成多个valve了,会出现多个accesslog文件</div><div class="line">                 * 直接从context取出的valve类型强制转换后和原valve相等(equals和==都一样,对象引用没变)</div><div class="line">                 */</div><div class="line">                 <span class="comment">// context.getPipeline().addValve(accessLogValve);</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"><span class="keyword">return</span> tomcatFactory;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>注意：</strong></p>
<div class="tip"><br>这里需要用context.getPipeline()来处理valve，如果直接用tomcatFactory.addContextValves(contextValves);这种方式的话，打开access开关会发现有两个accesslog文件，一个是spring-boot默认的按照日期的，一个是咱们定制的按照小时的。当然，也可以修改accesslog的格式为logback支持的方式。<br></div>

<p><strong>参考文章</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">http://stackoverflow.com/questions/23596157/spring-boot-tomcat-access-logs/35001421#35001421</div><div class="line">http://stackoverflow.com/questions/28483064/how-do-i-configure-the-location-and-name-of-tomcat-access-log-in-spring-boot?rq=1</div><div class="line">http://stackoverflow.com/questions/20574972/spring-boot-jetty-tomcat-embedded-access-log-configuration?rq=1</div><div class="line">https://tomcat.apache.org/tomcat-7.0-doc/config/http.html</div><div class="line">https://tomcat.apache.org/tomcat-7.0-doc/config/valve.html#Access_Log_Valve</div><div class="line">http://www.tuicool.com/articles/ymyiuiu</div></pre></td></tr></table></figure></p>
<p><strong>修改后最终的配置支持如下：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#server.tomcat.access config</div><div class="line">server.tomcat.accesslog.enabled=true</div><div class="line">server.tomcat.accesslog.accessLogBufferedEnabled=false</div><div class="line">server.tomcat.accesslog.pattern=%&#123;X-Forwarded-For&#125;i %l %u %t &quot;%r&quot; %s %b %D</div><div class="line">#server.tomcat.accesslog.directory=logs</div><div class="line">#server.tomcat.accesslog.prefix=account-access</div><div class="line">#server.tomcat.accesslog.suffix=.log</div><div class="line">#server.tomcat.accesslog.fileDateFormat=.yyyy-MM-dd.HH</div></pre></td></tr></table></figure></p>
<p>注释的配置都在启动脚本里按照不同机器的端口号等进行设置了，配置生效的标准是先启动脚本命令行，再配置文件</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/09/06/新上线java工程的常规检查工作/" class="prev">PREV</a><a href="/2016/08/31/spring-boot日志问题一：去除默认的console输出/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 <a href="http://www.coffeesweet.me">coffeesweet</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>